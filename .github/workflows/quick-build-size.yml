name: å¿«é€Ÿæ„å»º - æ˜¾ç¤ºé•œåƒå¤§å°

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # æ˜Ÿæ ‡ä»“åº“æ—¶è§¦å‘
  watch:
    types: [started]

jobs:
  quick_build:
    runs-on: ubuntu-22.04
    name: å¿«é€Ÿæ„å»ºå’Œå¤§å°æ£€æŸ¥
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      # è®¾ç½® Docker Buildx
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
      - name: åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
        run: make version
      
      # åˆ›å»ºçŸ­æäº¤å“ˆå¸Œ
      - name: åˆ›å»ºçŸ­æäº¤å“ˆå¸Œ
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV
      
      # æ„å»º Docker é•œåƒ
      - name: æ„å»º Docker é•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/main/Dockerfile
          push: false
          load: true
          platforms: linux/amd64
          target: frigate
          tags: frigate:test-${{ env.SHORT_SHA }}
          outputs: type=docker,dest=/tmp/image.tar
      
      # è·å–å¹¶æ˜¾ç¤ºé•œåƒå¤§å°
      - name: è·å–å¹¶æ˜¾ç¤ºé•œåƒå¤§å°
        run: |
          echo "ğŸ³ æ­£åœ¨åŠ è½½ Docker é•œåƒ..."
          docker load -i /tmp/image.tar
          
          echo ""
          echo "ğŸ“Š === FRIGATE DOCKER é•œåƒå¤§å°æŠ¥å‘Š ==="
          echo "ä»“åº“: ${{ github.repository }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤: ${{ env.SHORT_SHA }}"
          echo "å¹³å°: linux/amd64"
          echo "ç‰ˆæœ¬: v0.16.0-rc4"
          echo ""
          
          echo "ğŸ“¦ é•œåƒè¯¦æƒ…:"
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.ID}}" | grep "frigate:test"
          
          echo ""
          echo "ğŸ” è¯¦ç»†å¤§å°åˆ†æ:"
          IMAGE_SIZE=$(docker images --format "{{.Size}}" | grep -v "SIZE" | head -1)
          echo "æ€»é•œåƒå¤§å°: $IMAGE_SIZE"
          
          echo ""
          echo "ğŸ“‹ å±‚ä¿¡æ¯:"
          docker history frigate:test-${{ env.SHORT_SHA }} --format "table {{.CreatedBy}}\t{{.Size}}" | head -10
          
          echo ""
          echo "ğŸ’¾ å¤§å°å¯¹æ¯”:"
          echo "- æ ‡å‡† Frigate é•œåƒ: ~2-4GB"
          echo "- åŒ…å« TensorRT: ~3-5GB"
          echo "- åŒ…å« GPU æ”¯æŒ: ~4-6GB"
          
          echo ""
          echo "âœ… æ„å»ºæˆåŠŸå®Œæˆ!"
          echo "é•œåƒæ ‡ç­¾: frigate:test-${{ env.SHORT_SHA }}"
      
      # åˆ›å»ºæ‘˜è¦
      - name: åˆ›å»ºæ‘˜è¦
        run: |
          echo "## ğŸ³ Frigate v0.16.0-rc4 Docker é•œåƒå¤§å°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: v0.16.0-rc4" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°**: linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ env.SHORT_SHA }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ é•œåƒè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒæ ‡ç­¾**: frigate:test-${{ env.SHORT_SHA }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºçŠ¶æ€**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ åç»­æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
          echo "1. æŸ¥çœ‹ä¸Šæ–¹æ„å»ºæ—¥å¿—è·å–è¯¦ç»†å¤§å°ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "2. å¦‚éœ€è¦å¯ä¸‹è½½é•œåƒæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "3. ä½¿ç”¨é•œåƒè¿›è¡Œæµ‹è¯•æˆ–éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
      
      # ä¸Šä¼ é•œåƒä½œä¸ºæ„å»ºäº§ç‰©
      - name: ä¸Šä¼ é•œåƒä½œä¸ºæ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frigate-v0.16.0-rc4-amd64
          path: /tmp/image.tar
          retention-days: 7
