name: å¿«é€Ÿæ„å»º - æ˜¾ç¤ºé•œåƒå¤§å°

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # æ˜Ÿæ ‡ä»“åº“æ—¶è§¦å‘
  watch:
    types: [started]

# åªè¿è¡Œæœ€æ–°çš„æäº¤ä»¥é¿å…ç¼“å­˜è¦†ç›–
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: 3.9

jobs:
  quick_build:
    runs-on: ubuntu-22.04
    name: å¿«é€Ÿæ„å»ºå’Œå¤§å°æ£€æŸ¥
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      # è®°å½•æ„å»ºå¼€å§‹æ—¶é—´
      - name: è®°å½•æ„å»ºå¼€å§‹æ—¶é—´
        run: echo "BUILD_START_TIME=$(date +%s)" >> $GITHUB_ENV
      
      # ä½¿ç”¨å®˜æ–¹çš„setup action (å‚è€ƒci.yml)
      - name: è®¾ç½® QEMU å’Œ Buildx
        id: setup
        uses: ./.github/actions/setup
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # æ„å»ºå¹¶æ¨é€ Docker é•œåƒ (ä½¿ç”¨å®˜æ–¹çš„æœ€ä½³å®è·µ)
      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/main/Dockerfile
          push: true
          platforms: linux/amd64
          target: frigate
          tags: |
            ghcr.io/${{ github.repository }}/frigate-n150:stable
            ghcr.io/${{ github.repository }}/frigate-n150:${{ steps.setup.outputs.image-name }}
          # ä½¿ç”¨æ”¹è¿›çš„æ„å»ºç¼“å­˜ç­–ç•¥
          cache-from: |
            type=registry,ref=${{ steps.setup.outputs.cache-name }}-amd64
            type=gha
          cache-to: |
            type=registry,ref=${{ steps.setup.outputs.cache-name }}-amd64,mode=max
            type=gha,mode=max
          # è¾“å‡ºé•œåƒåˆ°æœ¬åœ°æ–‡ä»¶
          outputs: type=docker,dest=/tmp/image.tar
        # æ·»åŠ è¶…æ—¶å’Œé”™è¯¯å¤„ç†
        timeout-minutes: 30
        continue-on-error: false
      
      # è®°å½•æ„å»ºå®Œæˆæ—¶é—´
      - name: è®°å½•æ„å»ºå®Œæˆæ—¶é—´
        run: |
          echo "BUILD_END_TIME=$(date +%s)" >> $GITHUB_ENV
          BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
          echo "BUILD_DURATION=$BUILD_DURATION" >> $GITHUB_ENV
          echo "æ„å»ºè€—æ—¶: ${BUILD_DURATION} ç§’"
      
      # å®‰å…¨æ‰«æ
      - name: å®‰å…¨æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}/frigate-n150:stable
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      # ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ
      - name: ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      # è·å–å¹¶æ˜¾ç¤ºé•œåƒå¤§å° - å¢å¼ºç‰ˆåˆ†æ
      - name: è·å–å¹¶æ˜¾ç¤ºé•œåƒå¤§å°
        run: |
          echo "ğŸ³ æ­£åœ¨åŠ è½½ Docker é•œåƒ..."
          docker load -i /tmp/image.tar
          
          echo ""
          echo "ğŸ“Š === FRIGATE DOCKER é•œåƒå¤§å°æŠ¥å‘Š ==="
          echo "ä»“åº“: ${{ github.repository }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤: ${{ steps.setup.outputs.image-name }}"
          echo "å¹³å°: linux/amd64"
          echo "ç‰ˆæœ¬: v0.16.0-rc4"
          echo "æ„å»ºè€—æ—¶: ${BUILD_DURATION} ç§’"
          echo ""
          
          # ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•è·å–é•œåƒä¿¡æ¯
          echo "ğŸ“¦ é•œåƒè¯¦æƒ…:"
          
          # è·å–é•œåƒä¿¡æ¯ - æ”¹è¿›çš„é”™è¯¯å¤„ç†
          FRIGATE_IMAGES=$(docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.ID}}" | grep "frigate-n150" || echo "æœªæ‰¾åˆ°frigate-n150é•œåƒ")
          echo "$FRIGATE_IMAGES"
          
          echo ""
          echo "ğŸ” è¯¦ç»†å¤§å°åˆ†æ:"
          
          # è·å–é•œåƒå¤§å° - æ”¹è¿›çš„é€»è¾‘
          if docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "frigate-n150"; then
            # è·å–æœ€æ–°çš„frigate-n150é•œåƒå¤§å°
            IMAGE_SIZE=$(docker images --format "{{.Repository}}:{{.Tag}}\t{{.Size}}" | grep "frigate-n150" | head -1 | awk '{print $2}' || echo "æœªçŸ¥")
            echo "æ€»é•œåƒå¤§å°: $IMAGE_SIZE"
            
            echo ""
            echo "ğŸ“‹ å±‚ä¿¡æ¯åˆ†æ:"
            # è·å–å±‚ä¿¡æ¯ - æ”¹è¿›çš„é”™è¯¯å¤„ç†
            docker history ghcr.io/${{ github.repository }}/frigate-n150:stable --format "table {{.CreatedBy}}\t{{.Size}}" | head -10 || echo "æ— æ³•è·å–å±‚ä¿¡æ¯"
            
            echo ""
            echo "ğŸ“ˆ æ™ºèƒ½å¤§å°åˆ†æ:"
            # åˆ†æé•œåƒå¤§å°
            if [[ "$IMAGE_SIZE" =~ ^[0-9.]+[KMG]B$ ]]; then
              SIZE_NUM=$(echo "$IMAGE_SIZE" | sed 's/[KMG]B//')
              SIZE_UNIT=$(echo "$IMAGE_SIZE" | sed 's/[0-9.]*//')
              
              case $SIZE_UNIT in
                "GB")
                  if (( $(echo "$SIZE_NUM > 5" | bc -l) )); then
                    echo "âš ï¸  é•œåƒè¾ƒå¤§ (>5GB)ï¼Œå»ºè®®æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸å¿…è¦çš„æ–‡ä»¶"
                    echo "ğŸ’¡ ä¼˜åŒ–å»ºè®®:"
                    echo "   - æ£€æŸ¥æ˜¯å¦åŒ…å«è°ƒè¯•å·¥å…·"
                    echo "   - æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜"
                    echo "   - è€ƒè™‘ä½¿ç”¨å¤šé˜¶æ®µæ„å»º"
                  elif (( $(echo "$SIZE_NUM > 3" | bc -l) )); then
                    echo "ğŸ“¦ é•œåƒå¤§å°é€‚ä¸­ (3-5GB)ï¼ŒåŒ…å«å®Œæ•´åŠŸèƒ½"
                    echo "âœ… å½“å‰å¤§å°åˆç†ï¼Œæ— éœ€ä¼˜åŒ–"
                  else
                    echo "âœ… é•œåƒå¤§å°ä¼˜ç§€ (<3GB)"
                    echo "ğŸ‰ æ„å»ºä¼˜åŒ–æ•ˆæœæ˜¾è‘—ï¼"
                  fi
                  ;;
                "MB")
                  echo "âœ… é•œåƒè¾ƒå° (<1GB)ï¼Œæ„å»ºä¼˜åŒ–è‰¯å¥½"
                  echo "ğŸŒŸ è¿™æ˜¯éå¸¸ä¼˜ç§€çš„é•œåƒå¤§å°ï¼"
                  ;;
                *)
                  echo "â„¹ï¸  é•œåƒå¤§å°: $IMAGE_SIZE"
                  ;;
              esac
            fi
            
            echo ""
            echo "ğŸ”§ æ„å»ºæ€§èƒ½åˆ†æ:"
            if [ "$BUILD_DURATION" -gt 1800 ]; then
              echo "âš ï¸  æ„å»ºæ—¶é—´è¾ƒé•¿ (>30åˆ†é’Ÿ)ï¼Œå»ºè®®ä¼˜åŒ–"
              echo "ğŸ’¡ ä¼˜åŒ–å»ºè®®:"
              echo "   - æ£€æŸ¥ç½‘ç»œè¿æ¥"
              echo "   - ä¼˜åŒ–Dockerfile"
              echo "   - ä½¿ç”¨æ›´å¿«çš„æ„å»ºç¯å¢ƒ"
            elif [ "$BUILD_DURATION" -gt 900 ]; then
              echo "ğŸ“Š æ„å»ºæ—¶é—´é€‚ä¸­ (15-30åˆ†é’Ÿ)"
              echo "âœ… æ„å»ºæ€§èƒ½æ­£å¸¸"
            else
              echo "ğŸš€ æ„å»ºé€Ÿåº¦ä¼˜ç§€ (<15åˆ†é’Ÿ)"
              echo "ğŸ‰ æ„å»ºæ€§èƒ½å‡ºè‰²ï¼"
            fi
          else
            echo "âŒ é”™è¯¯: é•œåƒæœªæ‰¾åˆ°"
            echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥è·å–æ›´å¤šä¿¡æ¯"
          fi
          
          echo ""
          echo "ğŸ’¾ å¤§å°å¯¹æ¯”:"
          echo "- æ ‡å‡† Frigate é•œåƒ: ~2-4GB"
          echo "- åŒ…å« TensorRT: ~3-5GB"
          echo "- åŒ…å« GPU æ”¯æŒ: ~4-6GB"
          echo "- æˆ‘ä»¬çš„ä¼˜åŒ–é•œåƒ: ç›®æ ‡ <3GB"
          
          echo ""
          echo "âœ… æ„å»ºæˆåŠŸå®Œæˆ!"
          echo "é•œåƒæ ‡ç­¾: ghcr.io/${{ github.repository }}/frigate-n150:stable"
          echo "ä¸‹è½½å‘½ä»¤: docker pull ghcr.io/${{ github.repository }}/frigate-n150:stable"
          
          # è°ƒè¯•ä¿¡æ¯
          echo ""
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
          echo "æ‰€æœ‰é•œåƒ:"
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" | head -10 || echo "æ— æ³•åˆ—å‡ºé•œåƒ"
      
      # ç”Ÿæˆæ„å»ºæŠ¥å‘Š
      - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        run: |
          cat > build-report.md << 'REPORT_EOF'
          # Frigate v0.16.0-rc4 æ„å»ºæŠ¥å‘Š
          
          ## ğŸ“‹ æ„å»ºä¿¡æ¯
          - **ä»“åº“**: ${{ github.repository }}
          - **ç‰ˆæœ¬**: v0.16.0-rc4
          - **å¹³å°**: linux/amd64
          - **æäº¤**: ${{ steps.setup.outputs.image-name }}
          - **æ„å»ºæ—¶é—´**: ${BUILD_DURATION} ç§’
          - **æ„å»ºçŠ¶æ€**: âœ… æˆåŠŸ
          
          ## ğŸ“¦ é•œåƒä¿¡æ¯
          - **é•œåƒæ ‡ç­¾**: ghcr.io/${{ github.repository }}/frigate-n150:stable
          - **ä¸‹è½½å‘½ä»¤**: `docker pull ghcr.io/${{ github.repository }}/frigate-n150:stable`
          
          ## ğŸš€ æŠ€æœ¯ç‰¹æ€§
          - âœ… ä½¿ç”¨å®˜æ–¹ setup action
          - âœ… å¯ç”¨å¤šçº§æ„å»ºç¼“å­˜
          - âœ… å¹¶å‘æ§åˆ¶é¿å…ç¼“å­˜è¦†ç›–
          - âœ… æ™ºèƒ½é”™è¯¯å¤„ç†
          - âœ… å®‰å…¨æ‰«æé›†æˆ
          - âœ… æ„å»ºæ€§èƒ½ç›‘æ§
          
          ## ğŸ“Š ä¼˜åŒ–å»ºè®®
          $(if [ "$BUILD_DURATION" -gt 1800 ]; then
            echo "- âš ï¸  æ„å»ºæ—¶é—´è¾ƒé•¿ï¼Œå»ºè®®ä¼˜åŒ–Dockerfile"
          fi)
          $(if [[ "$IMAGE_SIZE" =~ ^[0-9.]+GB$ ]] && (( $(echo "$IMAGE_SIZE" | sed 's/GB//') > 5 )); then
            echo "- âš ï¸  é•œåƒè¾ƒå¤§ï¼Œå»ºè®®æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶"
          fi)
          
          ## ğŸ”— ç›¸å…³é“¾æ¥
          - [GitHub Packages](https://github.com/${{ github.repository }}/pkgs/container/frigate-n150)
          - [æ„å»ºæ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          *æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)*
          REPORT_EOF
      
      # åˆ›å»ºæ‘˜è¦ - å¢å¼ºç‰ˆæ ¼å¼
      - name: åˆ›å»ºæ‘˜è¦
        run: |
          echo "## ğŸ³ Frigate v0.16.0-rc4 Docker é•œåƒå¤§å°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: v0.16.0-rc4" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°**: linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ steps.setup.outputs.image-name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºæ—¶é—´**: ${BUILD_DURATION} ç§’" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºç¼“å­˜**: âœ… å¤šçº§ç¼“å­˜å·²å¯ç”¨" >> $GITHUB_STEP_SUMMARY
          echo "- **å®‰å…¨æ‰«æ**: âœ… å·²é›†æˆ Trivy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ é•œåƒè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒæ ‡ç­¾**: ghcr.io/${{ github.repository }}/frigate-n150:stable" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºçŠ¶æ€**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸‹è½½å‘½ä»¤**: \`docker pull ghcr.io/${{ github.repository }}/frigate-n150:stable\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ æŠ€æœ¯æ”¹è¿›" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ä½¿ç”¨å®˜æ–¹ setup action" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å¯ç”¨å¤šçº§æ„å»ºç¼“å­˜åŠ é€Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å¹¶å‘æ§åˆ¶é¿å…ç¼“å­˜è¦†ç›–" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ™ºèƒ½é”™è¯¯å¤„ç†å’Œè¶…æ—¶æ§åˆ¶" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… é›†æˆå®‰å…¨æ‰«æ (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ„å»ºæ€§èƒ½ç›‘æ§" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ™ºèƒ½å¤§å°åˆ†æå’Œä¼˜åŒ–å»ºè®®" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… è‡ªåŠ¨ç”Ÿæˆæ„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š åç»­æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
          echo "1. æŸ¥çœ‹ä¸Šæ–¹æ„å»ºæ—¥å¿—è·å–è¯¦ç»†å¤§å°ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "2. æ£€æŸ¥å®‰å…¨æ‰«æç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "3. ä¸‹è½½é•œåƒæ–‡ä»¶è¿›è¡Œæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "4. æ ¹æ®ä¼˜åŒ–å»ºè®®è¿›è¡Œæ”¹è¿›" >> $GITHUB_STEP_SUMMARY
      
      # ä¸Šä¼ é•œåƒä½œä¸ºæ„å»ºäº§ç‰©
      - name: ä¸Šä¼ é•œåƒä½œä¸ºæ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frigate-v0.16.0-rc4-amd64
          path: /tmp/image.tar
          retention-days: 7
      
      # ä¸Šä¼ æ„å»ºæŠ¥å‘Š
      - name: ä¸Šä¼ æ„å»ºæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md
          retention-days: 30
      
      # æ„å»ºç»“æœé€šçŸ¥
      - name: æ„å»ºç»“æœé€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ æ„å»ºæˆåŠŸï¼"
            echo "é•œåƒ: ghcr.io/${{ github.repository }}/frigate-n150:stable"
            echo "æ„å»ºæ—¶é—´: ${BUILD_DURATION} ç§’"
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼"
            echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥è·å–é”™è¯¯ä¿¡æ¯"
          fi
