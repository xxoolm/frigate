# 上游仓库同步指导文档（优化版）

## 项目背景
本项目是基于 [blakeblackshear/frigate](https://github.com/blakeblackshear/frigate) 的中文社区优化版本，需要定期与上游仓库同步以获取最新的稳定版本更新，同时保留我们自己的定制修改。

## 同步目标
1. 从上游仓库 https://github.com/blakeblackshear/frigate 获取 v0.16.0 稳定版代码
2. 将上游更新同步到本地的 upstream/v0.16.0 分支
3. 精细控制地将上游更新合并到我们的工作分支中，**保留关键定制内容**
4. **对每个文件单独确认合并**，确保只接受必要的上游更改

## 实施步骤

### 1. 准备工作
```bash
# 确认远程仓库配置
git remote -v
# 预期输出应包含：
# origin    https://github.com/xxoolm/frigate.git (fetch/push)
# upstream  https://github.com/blakeblackshear/frigate.git (fetch/push)

# 如果尚未添加上游仓库，执行以下命令
git remote add upstream https://github.com/blakeblackshear/frigate.git 2>/dev/null || true
```

### 2. 更新上游仓库数据
```bash
# 从上游仓库获取最新数据
git fetch upstream

# 确认v0.16.0标签存在（推荐使用此命令）
git ls-remote --tags upstream | grep -E "v?0?\.?16\.0$"
# 说明：此命令直接查询远程仓库，比git tag更可靠，尤其适用于首次同步

# 可选：查看v0.16.0的详细信息
git show upstream/v0.16.0
```

### 3. 更新本地 upstream/v0.16.0 分支
```bash
# 检查本地是否有upstream/v0.16.0分支
if ! git show-ref --quiet refs/heads/upstream/v0.16.0; then
  # 如果不存在，基于上游标签创建
  git checkout -b upstream/v0.16.0 upstream/v0.16.0
else
  # 如果存在，更新到最新
  git checkout upstream/v0.16.0
  git reset --hard upstream/v0.16.0
fi

# 可选：推送到个人仓库备份
git push origin upstream/v0.16.0 --force
```

### 4. 准备合并到工作分支（关键步骤）

#### 4.1 创建合并预览，不自动提交
```bash
# 切换到您的工作分支（替换为您的实际分支名）
git checkout your-working-branch

# 创建合并预览，不自动提交（保留工作区文件）
git merge upstream/v0.16.0 --no-commit --no-ff
```

> **重要说明**：`--no-commit`参数使Git不会自动提交合并结果，让您有机会在提交前检查所有更改。
> 
> **`--no-ff`参数**：保留合并历史，即使可以快进(fast-forward)也创建合并提交，便于后续追踪。

#### 4.2 交互式合并：每个文件单独确认（核心优化）

```bash
# 查看合并状态，了解哪些文件有冲突
git status

# 方法一：交互式选择每个文件的更改（推荐）
git checkout -p upstream/v0.16.0

# 方法二：对特定类型文件批量处理
# 1. 保留我们自己的模型缓存结构
git checkout --ours config/model_cache/
git checkout --ours scripts/download_models.sh

# 2. 保留所有中文文档
git checkout --ours README.md
git checkout --ours docs/
git checkout --ours CHANGELOG.md

# 3. 保留AI开发标记
git grep -l "部分代码由AI辅助开发" | xargs git checkout --ours
git grep -l "AL-generated" | xargs git checkout --ours

# 4. 交互式处理其他文件（逐个确认）
git checkout -p upstream/v0.16.0
```

> **逐文件合并详解**：
> 
> 1. **`git checkout -p upstream/v0.16.0`** 命令会：
>    - 逐块(hunk)显示上游更改
>    - 对每个代码块提供交互式选项
>    - 允许您选择接受/拒绝每个更改
> 
> 2. **交互选项说明**：
>    - `y` - 应用此块
>    - `n` - 跳过此块
>    - `q` - 退出，不再应用任何块
>    - `a` - 应用此块及所有后续块
>    - `d` - 显示此块的diff
>    - `s` - 拆分当前块为更小的块
>    - `e` - 手动编辑当前块
> 
> 3. **特别注意**：
>    - 对于模型配置文件，优先保留我们的`/config/model_cache/`结构
>    - 对于核心代码，优先考虑接受上游更新
>    - 对于中文文档，保留我们的修改
>    - 对于AI辅助开发的脚本，保留我们的标记

#### 4.3 检查特定文件的差异
```bash
# 比较配置文件差异（重点关注）
git diff upstream/v0.16.0:config/config.yml config/config.yml

# 比较模型相关文件
git diff upstream/v0.16.0:frigate/model.py frigate/model.py

# 比较Dockerfile
git diff upstream/v0.16.0:Dockerfile Dockerfile
```

### 5. 精细处理合并结果

#### 5.1 按文件类型处理策略
```bash
# 1. 模型相关文件处理（优先保留我们的结构）
# 恢复我们的模型缓存目录结构
cp -r config/model_cache/ config/model_cache_backup/
git checkout --theirs frigate/model.py frigate/ai/
cp -r config/model_cache_backup/* config/model_cache/
rm -rf config/model_cache_backup/

# 2. 文档文件处理（保留中文修改）
git checkout --ours README.md docs/ CHANGELOG.md

# 3. 构建脚本处理（保留AI辅助开发标记）
git checkout --ours scripts/build_utils.py scripts/download_models.sh

# 4. 配置文件处理（选择性合并）
git checkout -p upstream/v0.16.0 -- config/config.yml

# 5. 检查所有AI开发标记是否保留
grep -r "部分代码由AI辅助开发\|AL-generated" . || echo "警告：未找到AI开发标记"
```

#### 5.2 手动解决复杂冲突
```bash
# 对于复杂冲突文件，使用合并工具
git mergetool

# 或者使用VS Code等编辑器打开冲突文件
code frigate/complex_file.py
```

### 6. 完成合并
```bash
# 标记所有冲突已解决
git add .

# 验证关键文件是否保留了我们的定制
git diff --cached | grep -A 5 "AL-generated" || echo "警告：AI开发标记可能丢失"

# 提交合并（添加详细说明）
git commit -m "合并上游 v0.16.0 更新 - 精细控制

上游版本: v0.16.0 (https://github.com/blakeblackshear/frigate/tree/v0.16.0)
合并日期: $(date +%Y-%m-%d)

【保留的定制内容】
- 中文文档结构与翻译 (docs/, README.md)
- 模型缓存路径 (/config/model_cache)
- 预集成AI模型配置
- AI辅助开发的脚本标记 (AL-generated)

【接受的上游更新】
- 核心检测算法改进
- 安全修复
- Home Assistant集成优化
- Web UI改进

【特别处理】
- 调整了模型下载路径以匹配我们的结构
- 保留了中文README和文档
- 修复了v0.16.0与我们定制脚本的兼容性问题"
```

## 注意事项

### 1. 重要文件处理策略
| 文件类型 | 处理策略 | 命令示例 |
|---------|---------|---------|
| **中文文档** | 优先保留本地修改 | `git checkout --ours README.md docs/` |
| **模型配置** | 保留我们的结构，接受核心逻辑更新 | `git checkout --ours config/model_cache/ && git checkout --theirs frigate/model.py` |
| **AI辅助脚本** | 保留AL-generated标记 | `git grep -l "AL-generated" \| xargs git checkout --ours` |
| **核心代码** | 优先接受上游更新 | `git checkout --theirs frigate/core/ frigate/events.py` |
| **配置文件** | 交互式选择性合并 | `git checkout -p upstream/v0.16.0 -- config/config.yml` |

### 2. 备份策略
```bash
# 在关键步骤前创建备份分支
git checkout -b backup-before-merge-$(date +%Y%m%d)

# 或者使用stash保存未提交的更改
git stash save "临时工作 - 合并前"
```

### 3. 验证合并质量
```bash
# 检查是否保留了AI开发标记
grep -r "部分代码由AI辅助开发\|AL-generated" . || echo "错误：AI开发标记丢失"

# 验证模型缓存结构
ls -la config/model_cache/ || echo "错误：模型缓存目录结构异常"

# 检查Docker构建是否正常
docker build -t frigate-merge-test . || echo "错误：Docker构建失败"
```

## 常见问题处理

### 1. 如果上游分支不存在
```bash
# 基于上游标签创建分支
git checkout -b upstream/v0.16.0 upstream/v0.16.0
```

### 2. 如果需要重新开始合并过程
```bash
# 取消当前合并
git merge --abort

# 或者重置到合并前状态
git reset --hard HEAD
```

### 3. 如果只想合并特定文件
```bash
# 仅合并特定文件（保留我们的修改）
git checkout upstream/v0.16.0 -- frigate/core.py frigate/events.py
```

### 4. 如果需要回退到合并前状态
```bash
# 查看合并前的提交
git reflog

# 回退到合并前的提交
git reset --hard <合并前的commit-hash>
```

## 验证同步结果

### 1. 基本验证
```bash
# 检查当前提交历史
git log --oneline -5

# 检查是否保留了我们的定制提交
git log --oneline --grep="中文\|定制\|优化\|AL-generated"
```

### 2. 深度验证
```bash
# 检查关键文件是否包含我们的标记
grep -r "AL-generated" . || echo "严重错误：AI开发标记丢失"

# 验证模型缓存结构完整性
ls -la config/model_cache/
# 应该包含: jina-clip-v2/ facedet/ lpr/ birds/

# 检查Docker构建是否成功
docker build -t frigate-merge-verify . && echo "构建成功"
```

## 后续操作建议

1. **测试验证**：在提交合并后，务必进行以下测试
   ```bash
   # 1. 构建测试
   docker build -t frigate-merge-test .
   
   # 2. 启动测试
   docker run --rm -p 5000:5000 frigate-merge-test
   
   # 3. 功能验证
   # - 检查Web UI是否正常
   # - 验证模型加载是否成功
   # - 测试AI检测功能
   ```

2. **文档更新**：在`CHANGELOG.md`中添加清晰说明
   ```markdown
   ## [2025-08-18] - v0.16.0-cn.1
   
   ### Merged
   - 从上游合并 v0.16.0 稳定版代码
   
   ### Retained
   - 中文文档结构与翻译
   - 模型缓存路径 (/config/model_cache)
   - 预集成AI模型配置
   - AI辅助开发的脚本标记 (AL-generated)
   ```

3. **定期同步**：建议每月执行一次同步流程，保持与上游的兼容性

## 专业提示

1. **使用GUI工具**：对于复杂合并，推荐使用VS Code的合并冲突解决器或`git mergetool`
   
2. **创建合并检查表**：为每次合并准备检查表，确保关键定制内容不丢失
   
3. **自动化验证**：考虑添加简单的验证脚本到项目中，自动检查合并后的关键要素

通过这种精细化的合并流程，您可以确保安全地将上游更新集成到您的项目中，同时保留所有重要的中文定制和AI辅助开发的标记，避免意外覆盖关键修改。