---
id: download-models
title: 模型下载脚本说明
---

# 模型下载脚本说明

此文档介绍了 Frigate 中用于预下载 AI 模型的脚本 `download_models.sh`，该脚本在容器启动时自动运行，确保所有必需的模型文件都已下载到模型缓存目录中。

## 脚本功能

该脚本的主要功能包括：

1. **模型预下载**：根据配置自动下载所需的模型文件到模型缓存目录
2. **目录结构创建**：自动创建所有必要的模型目录结构
3. **磁盘空间检查**：在下载前检查磁盘空间是否充足
4. **下载重试机制**：实现指数退避重试机制，提高下载成功率
5. **文件完整性验证**：对关键模型文件进行大小验证
6. **多协议支持**：同时支持 wget 和 curl 下载方式
7. **状态文件生成**：创建模型状态文件以供系统识别

## 支持的模型类型

脚本会下载以下几种 AI 模型：

### 1. 语义搜索模型 (JinaV2 Large)
- 模型文件: `model_fp16.onnx`
- 分词器文件: `tokenizer.json`, `tokenizer_config.json`, `special_tokens_map.json`
- 存储路径: `/config/model_cache/jinaai/jina-clip-v2/`

### 2. 人脸识别模型 (Large)
- 人脸检测: `facedet.onnx`, `landmarkdet.yaml`, `facenet.tflite`
- 人脸嵌入: `arcface.onnx`
- 存储路径: `/config/model_cache/facedet/`

### 3. 车牌识别模型
- 车牌检测: `yolov9-256-license-plates.onnx`
- 车牌分类: `classification.onnx`
- 车牌识别: `recognition.onnx`
- 存储路径: `/config/model_cache/yolov9_license_plate/` 和 `/config/model_cache/paddleocr-onnx/`

### 4. 鸟类分类模型
- 分类模型: `bird.tflite`
- 标签文件: `birdmap.txt`
- 存储路径: `/config/model_cache/bird/`

## 下载机制

### 磁盘空间检查
脚本在下载每种模型前会检查磁盘空间是否充足：
- 语义搜索模型: 需要约 2GB 空间
- 人脸识别模型: 需要约 500MB 空间
- 车牌识别模型: 需要约 500MB 空间
- 鸟类分类模型: 需要约 100MB 空间

### 重试机制
脚本实现了智能重试机制：
- 最大重试次数: 5次
- 初始延迟: 5秒
- 指数退避: 每次重试延迟时间翻倍
- 多协议支持: wget 失败后自动尝试 curl

### 文件验证
对关键模型文件进行完整性检查：
- `model_fp16.onnx`: 验证文件大小是否达到预期的 95% 以上

## 使用说明

### 自动运行
脚本在容器启动时自动运行，无需手动执行。

### 手动运行
如果需要手动重新下载模型，可以通过以下方式执行：
```bash
# 进入容器
docker exec -it frigate bash

# 运行脚本
/download_models.sh
```

### 环境变量
脚本会使用以下环境变量：
- `MODEL_CACHE_DIR`: 模型缓存目录，默认为 `/config/model_cache`

## 故障排除

### 下载失败
如果模型下载失败，可以尝试以下解决方案：
1. 检查网络连接是否正常
2. 确认磁盘空间是否充足
3. 手动运行脚本查看详细错误信息
4. 尝试使用不同的网络环境

### 磁盘空间不足
如果提示磁盘空间不足：
1. 清理不必要的文件释放空间
2. 修改配置禁用不需要的模型功能
3. 使用外部存储挂载更多空间

### 权限问题
如果遇到权限问题：
1. 确认容器有正确的文件系统权限
2. 检查挂载的卷权限设置
3. 确保模型缓存目录可写

## 注意事项

1. **首次启动时间**：由于需要下载大量模型文件，首次启动可能需要较长时间
2. **网络要求**：需要稳定的网络连接以完成模型下载
3. **存储要求**：确保有足够的存储空间（建议至少 4GB 可用空间）
4. **模型更新**：模型文件更新时会自动重新下载