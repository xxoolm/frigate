---
id: quick-build-size-workflow
title: 快速构建工作流说明
---

# 快速构建工作流说明

此文档详细介绍了 Frigate 项目的 GitHub Actions 工作流文件 `quick-build-size.yml`，该工作流用于快速构建 Docker 镜像并显示镜像大小信息。

## 工作流概述

该工作流的主要功能包括：
1. 构建 Frigate Docker 镜像
2. 测量和报告镜像大小
3. 优化构建过程以节省磁盘空间
4. 生成详细的构建报告

## 触发条件

工作流可以通过以下方式触发：
1. **手动触发**：通过 GitHub 界面手动运行
2. **星标触发**：当用户为仓库添加星标时自动触发

## 并发控制

为避免缓存覆盖，工作流配置了并发控制：
- 只运行最新的提交
- 会取消正在进行的同一批次工作流

## 环境变量

工作流设置了以下环境变量：
- `PYTHON_VERSION`: Python 版本（3.9）

## 工作流作业

### 作业名称
`quick_build` - 在 Ubuntu 22.04 环境中运行

### 构建步骤详解

#### 1. 代码检出
- 使用 `actions/checkout@v4` 检出代码
- 禁用持久化凭证以提高安全性

#### 2. 构建时间记录
- 记录构建开始时间
- 创建短提交哈希用于镜像标签

#### 3. 系统空间深度清理
为确保有足够的磁盘空间进行构建，执行以下清理操作：
- 清理系统包缓存
- 清理 npm 和 pip 缓存
- 清理旧的 Docker 镜像和卷
- 清理 GitHub Actions 运行器缓存
- 清理系统日志文件

#### 4. 临时目录重定向
- 创建新的临时目录 `/var/lib/docker/tmp`
- 将临时环境变量重定向到新目录
- 验证目录权限和写入能力

#### 5. BuildKit GC 策略配置
- 配置 BuildKit 垃圾回收策略
- 设置最大存储限制为 10GB
- 保持默认存储为 1GB

#### 6. 空间配置验证
- 验证临时目录位置
- 检查 BuildKit 配置
- 显示磁盘空间使用情况

#### 7. 导出目录准备
- 确保导出目录存在
- 验证目录权限
- 测试写入能力

#### 8. QEMU 和 Buildx 设置
- 使用自定义的 setup action 配置构建环境
- 传递 GitHub Token 用于认证

#### 9. Docker 镜像构建和推送
这是核心步骤，包含以下配置：
- 构建上下文：当前目录
- Dockerfile：`docker/main/Dockerfile`
- 推送镜像：是
- 平台：linux/amd64
- 构建目标：frigate
- 镜像标签：
  - `ghcr.io/${{ github.repository }}/frigate-n150:stable`
  - `ghcr.io/${{ github.repository }}/frigate-n150:${{ env.SHORT_SHA }}`
- 缓存策略：
  - 从 GitHub Container Registry 读取缓存
  - 写入缓存到 GitHub Container Registry
- 输出：将镜像导出到 `/var/lib/docker/tmp/image.tar`
- 超时：30分钟

#### 10. 构建时间记录完成
- 记录构建完成时间
- 计算构建耗时

#### 11. 最终空间验证
- 验证构建完成后的磁盘空间使用情况
- 检查临时目录使用情况
- 检查 Docker 卷使用情况

#### 12. 镜像大小获取和分析
- 从导出文件加载 Docker 镜像
- 显示详细的镜像信息
- 分析镜像大小并与标准大小对比
- 显示镜像层信息

#### 13. 构建报告生成
生成包含以下信息的详细报告：
- 构建信息（仓库、分支、提交、平台、版本、构建耗时）
- 镜像信息（标签、大小、下载命令）
- 镜像大小分析（根据大小给出评估和优化建议）
- 构建优化措施（磁盘空间优化、模型预下载、缓存策略）
- 预下载模型列表（语义搜索、人脸识别、车牌识别、鸟类分类）
- 使用说明（拉取镜像、运行容器、访问界面）
- 性能指标（构建成功率、磁盘空间优化、模型完整性、缓存效率）

#### 14. 构建摘要创建
- 在 GitHub Actions 摘要中显示构建信息
- 包含与构建报告相同的详细信息

#### 15. 构建报告上传
- 将生成的构建报告作为工件上传
- 保留天数：30天

#### 16. 导出文件清理
- 清理临时导出的镜像文件
- 无论构建成功与否都会执行

## 空间优化措施

工作流实现了多种空间优化措施：
1. **系统清理**：清理包管理器缓存、日志文件等
2. **临时目录重定向**：将临时文件重定向到更大的卷
3. **BuildKit GC 配置**：优化 BuildKit 的垃圾回收策略
4. **Docker 清理**：清理旧的镜像和卷

## 预下载模型

在构建过程中会预下载以下 AI 模型：
1. **语义搜索模型**：JinaV2 Large（包含 tokenizer）
2. **人脸识别模型**：Large（ArcFace + 检测模型 + facenet.tflite）
3. **车牌识别模型**：完整 LPR 模型集（YOLOv9 + PaddleOCR）
4. **鸟类分类模型**：完整分类模型

## 镜像大小分析

工作流会根据镜像大小提供评估：
- **>5GB**：较大，建议检查是否包含不必要的文件
- **3-5GB**：适中，当前大小合理，包含完整功能
- **<3GB**：优秀，构建优化效果显著
- **<1GB**：较小，这是非常优秀的镜像大小

## 使用说明

工作流生成的镜像可以通过以下方式使用：
1. 拉取镜像：`docker pull ghcr.io/${{ github.repository }}/frigate-n150:stable`
2. 运行容器：`docker run -p 5000:5000 ghcr.io/${{ github.repository }}/frigate-n150:stable`
3. 访问界面：http://localhost:5000

## 注意事项

1. 构建过程可能需要较长时间，特别是模型下载阶段
2. 需要足够的磁盘空间（建议至少 15GB 可用空间）
3. 首次构建时会下载大量依赖，需要稳定的网络连接
4. 工作流会自动清理临时文件以节省空间